<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>캐릭터 카드 목록 — index</title>
  <style>
    :root {
      --bg: #0f1724;
      --card: #0b1220;
      --accent: #7c3aed;
      --glass: rgba(255, 255, 255, 0.04);
      --muted: #9aa3b2
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: Inter, system-ui, Segoe UI, Roboto, 'Noto Sans KR', sans-serif;
      background: #071225;
      color: #e6eef8;
      min-height: 100vh
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 28px
    }

    .brand {
      display: flex;
      gap: 12px;
      align-items: center
    }

    .logo {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--accent), #06b6d4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700
    }

    .controls {
      display: flex;
      gap: 12px;
      align-items: center
    }

    .profile {
      display: flex;
      gap: 8px;
      align-items: center
    }

    #g_id_signin {
      display: block
    }

    .grid {
      padding: 24px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 20px;
      max-width: 1200px;
      margin: 0 auto
    }

    .card {
      background: var(--card);
      border-radius: 14px;
      padding: 16px;
      position: relative;
      box-shadow: 0 6px 20px rgba(2, 6, 23, 0.6);
      cursor: pointer
    }

    .card:hover {
      box-shadow: 0 12px 34px rgba(2, 6, 23, 0.9)
    }

    .avatar {
      height: 140px;
      background: linear-gradient(120deg, #0ea5a9, #7c3aed);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 30px;
      margin-bottom: 12px
    }

    .title {
      font-weight: 700;
      font-size: 18px
    }

    .role {
      font-size: 14px;
      color: var(--muted)
    }

    .like-row {
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 8px
    }

    .like-btn {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, .06);
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px
    }

    .like-btn[disabled] {
      opacity: .45;
      cursor: not-allowed
    }

    .liked {
      background: linear-gradient(90deg, var(--accent), #06b6d4);
      color: #021428;
      border: none
    }

    .details {
      margin-top: 12px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      display: none
    }

    .details.open {
      display: block
    }

    .row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 14px
    }

    footer {
      padding: 28px;
      text-align: center;
      color: var(--muted)
    }
  </style>
</head>

<body>
  <header>
    <div class="brand">
      <div class="logo">C</div>
      <div>
        <div style="font-weight:700">캐릭터 갤러리</div>
        <div style="font-size:13px;color:var(--muted)">클릭하면 상세 스탯이 열립니다 — 좋아요는 구글 로그인 필요</div>
      </div>
    </div>

    <div class="controls">
      <div id="userArea" class="profile">
        <div id="signedOutArea">
          <div id="g_id_signin"></div>
        </div>
        <div id="signedInArea" style="display:none;align-items:center;gap:10px">
          <img id="userPic" src="" alt=""
            style="width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,.06)" />
          <div id="userName" style="font-size:14px"></div>
          <button id="signOutBtn"
            style="padding:8px 10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,.06);cursor:pointer">로그아웃</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <section class="grid" id="cardsGrid"></section>
  </main>

  <footer>
    <div style="color:var(--muted)">※ 좋아요는 구글 계정으로 로그인해야 활성화됩니다. (현재는 로컬Storage 기반; 서버 동기화 원하면 알려주세요)</div>
  </footer>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <script>
    // ======= 설정: 여기에 실제 클라이언트 아이디를 넣어주세요 =======
    const GOOGLE_CLIENT_ID = 'REPLACE_WITH_YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com';
    // ==============================================================

    const characters = [
      { id: 'char01', name: '아리아', role: '원거리 딜러', skills: ['화살비', '역전의 한방', '연사'] },
      { id: 'char02', name: '브록', role: '탱커', skills: ['도발', '방패막기', '지진'] },
      { id: 'char03', name: '셀레네', role: '서포트', skills: ['치유파동', '가호', '속도증폭'] },
      { id: 'char04', name: '다이몬', role: '근접 전사', skills: ['연속베기', '강습', '분쇄'] }
    ];

    const STORAGE_KEYS = { COUNTS: 'likes_counts_v1', USER_LIKES: 'user_likes_v1' };
    function loadCounts() { try { return JSON.parse(localStorage.getItem(STORAGE_KEYS.COUNTS) || '{}') } catch { return {} } }
    function saveCounts(o) { localStorage.setItem(STORAGE_KEYS.COUNTS, JSON.stringify(o)) }
    function loadUserLikes() { try { return JSON.parse(localStorage.getItem(STORAGE_KEYS.USER_LIKES) || '{}') } catch { return {} } }
    function saveUserLikes(o) { localStorage.setItem(STORAGE_KEYS.USER_LIKES, JSON.stringify(o)) }

    let currentUser = null; // signed-in user payload ({sub, name, picture, email...})

    function renderCards() {
      const grid = document.getElementById('cardsGrid');
      grid.innerHTML = '';
      const counts = loadCounts();
      const userLikes = loadUserLikes();
      const uid = currentUser?.sub || null;

      characters.forEach(ch => {
        const liked = uid && userLikes[uid] && userLikes[uid][ch.id];
        const count = counts[ch.id] || 0;

        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div class="avatar">${ch.name[0]}</div>
          <div class="title">${ch.name}</div>
          <div class="role">${ch.role}</div>

          <div class="like-row">
            <div class="count" id="count-${ch.id}">${count}</div>
            <button class="like-btn ${liked ? 'liked' : ''}" data-id="${ch.id}" ${uid ? '' : 'disabled'}>
              <span class="btn-text">${liked ? '좋아요 취소' : '좋아요'}</span>
            </button>
          </div>

          <div class="details" id="detail-${ch.id}">
            <div class="row"><div>이름</div><div>${ch.name}</div></div>
            <div class="row"><div>역할군</div><div>${ch.role}</div></div>
            <div class="row"><div>스킬</div><div>${ch.skills.join(', ')}</div></div>
            <!-- 필요한 항목 더 추가하세요 -->
          </div>
        `;

        // 카드 클릭: 상세 열기/닫기 (좋아요 버튼 클릭은 제외)
        div.addEventListener('click', e => {
          if (e.target.closest('.like-btn')) return; // 좋아요 클릭이면 무시
          const box = document.getElementById(`detail-${ch.id}`);
          box.classList.toggle('open');
        });

        grid.appendChild(div);
      });

      // attach like handlers
      document.querySelectorAll('.like-btn').forEach(btn => {
        btn.onclick = (e) => { e.stopPropagation(); handleLikeClick(btn.dataset.id, btn); };
      });
    }

    function handleLikeClick(charId, btnElement) {
      if (!currentUser) {
        alert('좋아요를 누르려면 구글 계정으로 로그인해야 합니다.');
        return;
      }
      const uid = currentUser.sub;
      const counts = loadCounts();
      const userLikes = loadUserLikes();
      userLikes[uid] = userLikes[uid] || {};

      const already = !!userLikes[uid][charId];
      if (already) { // unlike
        delete userLikes[uid][charId];
        counts[charId] = Math.max(0, (counts[charId] || 0) - 1);
      } else { // like
        userLikes[uid][charId] = true;
        counts[charId] = (counts[charId] || 0) + 1;
      }
      saveCounts(counts); saveUserLikes(userLikes);
      renderCards();
    }

    // --- Google Identity helpers ---
    function decodeJwtResponse(token) {
      const parts = token.split('.');
      if (parts.length !== 3) return null;
      try {
        const payload = parts[1];
        const json = atob(payload.replace(/-/g, '+').replace(/_/g, '/'));
        return JSON.parse(decodeURIComponent(escape(json)));
      } catch (e) { console.error('JWT decode failed', e); return null }
    }

    function handleCredentialResponse(response) {
      const payload = decodeJwtResponse(response.credential);
      if (payload) {
        currentUser = payload; // has .sub, .name, .picture, .email
        onSignedIn(payload);
      }
    }

    function onSignedIn(payload) {
      document.getElementById('signedOutArea').style.display = 'none';
      document.getElementById('signedInArea').style.display = 'flex';
      document.getElementById('userPic').src = payload.picture || '';
      document.getElementById('userName').textContent = payload.name || payload.email || 'user';
      renderCards();
    }

    function signOut() {
      // clear local client state; note: to fully revoke server-side tokens you'd call Google APIs
      currentUser = null;
      document.getElementById('signedOutArea').style.display = 'block';
      document.getElementById('signedInArea').style.display = 'none';
      renderCards();
    }

    // init
    window.onload = () => {
      renderCards();

      if (!GOOGLE_CLIENT_ID || GOOGLE_CLIENT_ID.includes('REPLACE_WITH')) {
        // client id 미설정: 로그인 UI 대신 안내문 표시
        document.getElementById('g_id_signin').innerHTML = '<div style="color:var(--muted);font-size:13px">개발자: GOOGLE_CLIENT_ID를 넣어야 구글 로그인 활성화됩니다.</div>';
        return;
      }

      google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: handleCredentialResponse });
      google.accounts.id.renderButton(document.getElementById('g_id_signin'), { theme: 'outline', size: 'large', text: 'signin_with' });
      // optional: google.accounts.id.prompt();
    };

    document.getElementById('signOutBtn').addEventListener('click', () => signOut());
  </script>
</body>

</html>
